@model SitefinityWebApp.Mvc.Models.MarkdownFieldViewModel

@using Telerik.Sitefinity.UI.MVC
@using Telerik.Sitefinity.Frontend.Mvc.Helpers
@using Telerik.Sitefinity.Modules.Pages

@Html.Script(ScriptRef.JQuery, "top", false)

@* Load TOAST UI Editor Viewer CSS for proper markdown rendering *@
@Html.StyleSheet(Url.WidgetContent("assets/vendor/toast-ui/toastui-editor-viewer.min.css"), "head", false)

@* Load TOAST UI Editor JavaScript for viewer *@
@Html.Script(Url.WidgetContent("assets/vendor/toast-ui/toastui-editor-all.min.js"), "bottom", false)

@if (Model.HasValue)
{
    <div class="@Model.CssClass form-group" data-sf-role="markdown-field-read-container">
        @* Label *@
        @if (!string.IsNullOrEmpty(Model.MetaField.Title))
        {
            <label class="h6">@Model.MetaField.Title</label>
        }
        
        @* Container for the markdown viewer *@
        <div id='@Html.UniqueId("MarkdownViewer")' 
             data-sf-role="markdown-viewer"
             class="markdown-viewer">
        </div>
        
        @* Hidden element to store the markdown content *@
        <script type="text/plain" data-sf-role="markdown-content">@Model.Value</script>
        
        @* Initialize the viewer *@
        <script>
            (function() {
                var viewerId = '@Html.Raw(Html.UniqueId("MarkdownViewer"))';
                var viewerEl = document.getElementById(viewerId);
                if (viewerEl && window.toastui && window.toastui.Editor) {
                    var container = viewerEl.closest('[data-sf-role="markdown-field-read-container"]');
                    var contentEl = container.querySelector('[data-sf-role="markdown-content"]');
                    var markdown = contentEl ? contentEl.textContent : '';
                    
                    // Create a viewer instance
                    var viewer = toastui.Editor.factory({
                        el: viewerEl,
                        viewer: true,
                        initialValue: markdown,
                        usageStatistics: false
                    });
                }
            })();
        </script>
    </div>
}
else
{
    @* Empty state - no value to display *@
    <div class="@Model.CssClass form-group">
        @if (!string.IsNullOrEmpty(Model.MetaField.Title))
        {
            <label class="h6">@Model.MetaField.Title</label>
        }
        <p class="text-muted"><em>No content</em></p>
    </div>
}
