name: Build Sitefinity

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Restore NuGet packages
      run: nuget restore SitefinityWebApp.sln

    - name: Build Solution
      run: msbuild SitefinityWebApp.csproj /p:Configuration=Release /p:Platform=AnyCPU

    - name: Check DLL Contents
      run: |
        Write-Host "=== DLL File Info ==="
        Get-Item bin/SitefinityWebApp.dll | Select-Object Name, Length, LastWriteTime

        Write-Host "`n=== Searching for MarkdownFieldControl in DLL ==="
        $content = [System.IO.File]::ReadAllText("$pwd\bin\SitefinityWebApp.dll", [System.Text.Encoding]::GetEncoding("ISO-8859-1"))
        if ($content -match "MarkdownFieldControl") {
          Write-Host "SUCCESS: MarkdownFieldControl IS in the DLL"
        } else {
          Write-Host "FAILURE: MarkdownFieldControl is NOT in the DLL"
        }

        Write-Host "`n=== Searching for other key strings ==="
        @("MarkdownFieldControl", "Global", "SitefinityWebApp", "FieldControl", "LayoutTemplatePath") | ForEach-Object {
          $found = $content -match $_
          Write-Host "$_ : $(if ($found) { 'FOUND' } else { 'NOT FOUND' })"
        }

        Write-Host "`n=== Using ildasm to list types ==="
        & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\ildasm.exe" /text /metadata bin/SitefinityWebApp.dll 2>$null | Select-String -Pattern "\.class.*public" | Select-Object -First 50
      shell: pwsh

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: compiled-dll
        path: |
          bin/SitefinityWebApp.dll
          bin/SitefinityWebApp.pdb
